<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Planning - Advanced Schedule Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --color-urgent: #ef4444;
            --color-high: #f97316;
            --color-normal: #eab308;
            --color-scheduled: #22c55e;
            --color-planned: #3b82f6;
            --color-unassigned: #6b7280;
            --color-forecast: #8b5cf6;
            --color-ai: #06b6d4;
        }

        .schedule-bar {
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            backdrop-filter: blur(4px);
        }
        
        .schedule-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 20;
        }
        
        .timeline-grid {
            background-image: repeating-linear-gradient(
                90deg,
                transparent,
                transparent calc(100% / 30 - 1px),
                rgba(75, 85, 99, 0.3) calc(100% / 30 - 1px),
                rgba(75, 85, 99, 0.3) calc(100% / 30)
            );
        }
        
        .today-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, #ef4444, #f97316);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
            z-index: 15;
        }
        
        .machine-row {
            transition: background-color 0.2s ease;
        }
        
        .machine-row:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        
        .capacity-bar {
            background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%);
            height: 4px;
            border-radius: 2px;
        }
        
        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        
        .scroll-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        
        .scroll-container::-webkit-scrollbar-track {
            background: #1f2937;
        }
        
        .scroll-container::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        
        .floating-stats {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container-fluid mx-auto p-4">
        <!-- Header with Controls -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-industry mr-2 text-blue-600"></i>
                        Machine Production Schedule Board
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">Real-time production planning & forecasting</p>
                </div>
                
                <div class="flex items-center gap-4 flex-wrap">
                    <!-- View Controls -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">View:</label>
                        <select id="viewRange" onchange="updateViewRange()" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                            <option value="7">7 Days</option>
                            <option value="14">14 Days</option>
                            <option value="30" selected>30 Days</option>
                            <option value="60">60 Days</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Group by:</label>
                        <select id="groupBy" onchange="updateGrouping()" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                            <option value="machine">Machine</option>
                            <option value="workcenter">Work Center</option>
                            <option value="priority">Priority</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <button onclick="toggleForecast()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-md text-sm font-medium">
                            <i class="fas fa-chart-line mr-1"></i>Show Forecast
                        </button>
                        <button onclick="optimizeSchedule()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded-md text-sm font-medium">
                            <i class="fas fa-magic mr-1"></i>AI Optimize
                        </button>
                        <button onclick="refreshSchedule()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm font-medium">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="currentDateTime"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
            <div class="bg-white rounded-lg shadow p-4 floating-stats">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 uppercase">Total Machines</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalMachines">0</p>
                    </div>
                    <i class="fas fa-cogs text-3xl text-blue-500 opacity-30"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4 floating-stats" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 uppercase">Active Orders</p>
                        <p class="text-2xl font-bold text-green-600" id="activeOrders">0</p>
                    </div>
                    <i class="fas fa-tasks text-3xl text-green-500 opacity-30"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4 floating-stats" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 uppercase">Unassigned</p>
                        <p class="text-2xl font-bold text-orange-600" id="unassignedOrders">0</p>
                    </div>
                    <i class="fas fa-exclamation-triangle text-3xl text-orange-500 opacity-30"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4 floating-stats" style="animation-delay: 0.6s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 uppercase">Total Demand (lbs)</p>
                        <p class="text-2xl font-bold text-blue-600" id="totalDemand">0</p>
                    </div>
                    <i class="fas fa-weight text-3xl text-blue-500 opacity-30"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4 floating-stats" style="animation-delay: 0.8s">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 uppercase">Forecasted (lbs)</p>
                        <p class="text-2xl font-bold text-purple-600" id="forecastedDemand">0</p>
                    </div>
                    <i class="fas fa-chart-line text-3xl text-purple-500 opacity-30"></i>
                </div>
            </div>
        </div>

        <!-- Main Schedule Board -->
        <div class="bg-gray-900 rounded-xl shadow-2xl p-6">
            <!-- Board Header -->
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-xl font-bold text-white">Production Schedule Timeline</h2>
                    <p class="text-sm text-gray-400 mt-1">Gantt view of machine assignments and capacity</p>
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center text-sm text-gray-300">
                        <input type="checkbox" id="showCapacity" onchange="toggleCapacity()" class="mr-2" checked>
                        Show Capacity
                    </label>
                    <label class="flex items-center text-sm text-gray-300">
                        <input type="checkbox" id="showUnassigned" onchange="toggleUnassigned()" class="mr-2" checked>
                        Show Unassigned
                    </label>
                </div>
            </div>

            <!-- Date Timeline Header -->
            <div class="mb-4 overflow-x-auto scroll-container">
                <div class="flex min-w-max">
                    <div class="w-48 pr-4 flex-shrink-0"></div>
                    <div class="flex-1 relative">
                        <div class="grid text-xs text-gray-400 text-center border-b border-gray-700 pb-2" id="dateHeader" style="grid-template-columns: repeat(30, minmax(40px, 1fr));">
                            <!-- Dynamic dates will be inserted here -->
                        </div>
                        <div class="today-marker" id="todayMarker"></div>
                    </div>
                </div>
            </div>

            <!-- Unassigned Demand Section -->
            <div id="unassignedSection" class="mb-4 bg-gray-800 rounded-lg p-3 border border-orange-500 border-opacity-50">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-bold text-orange-400">
                        <i class="fas fa-exclamation-circle mr-2"></i>Unassigned Demand
                    </h3>
                    <button onclick="autoAssign()" class="text-xs bg-orange-600 hover:bg-orange-700 text-white px-2 py-1 rounded">
                        <i class="fas fa-magic mr-1"></i>Auto-Assign
                    </button>
                </div>
                <div id="unassignedList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                    <!-- Unassigned orders will be displayed here -->
                </div>
            </div>

            <!-- Forecasted Demand Section -->
            <div id="forecastSection" class="mb-4 bg-gray-800 rounded-lg p-3 border border-purple-500 border-opacity-50" style="display: none;">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-bold text-purple-400">
                        <i class="fas fa-chart-bar mr-2"></i>Forecasted Demand (Next 30 Days)
                    </h3>
                    <span class="text-xs text-gray-400" id="forecastAccuracy">Accuracy: 0%</span>
                </div>
                <div id="forecastChart" class="h-24 bg-gray-900 rounded p-2">
                    <!-- Forecast visualization will be here -->
                </div>
            </div>

            <!-- Schedule Grid -->
            <div id="scheduleGrid" class="space-y-1 overflow-x-auto scroll-container max-h-[600px]">
                <!-- Loading indicator -->
                <div class="text-center py-8 text-gray-400" id="loadingIndicator">
                    <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                    <p class="text-lg">Loading production schedule...</p>
                    <p class="text-sm text-gray-500 mt-2">Fetching machine data and orders...</p>
                </div>
            </div>

            <!-- Legend -->
            <div class="mt-6 pt-4 border-t border-gray-700">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 text-xs">
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-2" style="background-color: var(--color-urgent);"></div>
                        <span class="text-gray-300">Urgent/Overdue</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-2" style="background-color: var(--color-high);"></div>
                        <span class="text-gray-300">High Priority</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-2" style="background-color: var(--color-normal);"></div>
                        <span class="text-gray-300">Normal</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-2" style="background-color: var(--color-scheduled);"></div>
                        <span class="text-gray-300">On Schedule</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-2" style="background-color: var(--color-planned);"></div>
                        <span class="text-gray-300">Planned</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-2" style="background-color: var(--color-unassigned);"></div>
                        <span class="text-gray-300">Unassigned</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-2" style="background-color: var(--color-forecast);"></div>
                        <span class="text-gray-300">Forecasted</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-2" style="background-color: var(--color-ai);"></div>
                        <span class="text-gray-300">AI Optimized</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">Order Details</h3>
                <button onclick="closeOrderModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="orderModalContent" class="space-y-4">
                <!-- Order details will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let viewDays = 30;
        let groupByMode = 'machine';
        let showForecast = false;
        let allMachines = [];
        let allOrders = [];
        let forecastData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateDateTime();
            setInterval(updateDateTime, 60000);
            updateDateHeader();
            loadAllData();
            positionTodayMarker();
        });

        // Update current date and time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDateTime').textContent = 
                now.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
        }

        // Position today marker
        function positionTodayMarker() {
            const marker = document.getElementById('todayMarker');
            const todayPosition = (0 / viewDays) * 100;
            marker.style.left = `${todayPosition}%`;
        }

        // Generate date header
        function updateDateHeader() {
            const header = document.getElementById('dateHeader');
            header.innerHTML = '';
            header.style.gridTemplateColumns = `repeat(${viewDays}, minmax(40px, 1fr))`;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < viewDays; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const day = date.getDate();
                const month = date.toLocaleDateString('en-US', { month: 'short' });
                const weekday = date.toLocaleDateString('en-US', { weekday: 'short' });
                
                const div = document.createElement('div');
                div.className = i === 0 ? 'border-r border-gray-700 bg-blue-900 bg-opacity-30 rounded' : 'border-r border-gray-700';
                
                // Highlight weekends
                if (weekday === 'Sat' || weekday === 'Sun') {
                    div.className += ' bg-gray-800 bg-opacity-50';
                }
                
                div.innerHTML = `
                    <div class="font-medium ${i === 0 ? 'text-blue-400' : ''}">${weekday}</div>
                    <div class="${i === 0 ? 'text-blue-300' : ''}">${month} ${day}</div>
                `;
                header.appendChild(div);
            }
        }

        // Load all data
        async function loadAllData() {
            try {
                // Show loading state
                updateLoadingState('Fetching production data...');
                
                console.log('Starting data fetch from APIs...');
                
                // Fetch all required data with error handling for each
                let planningData = { production_schedule: [] };
                let factoryData = { work_center_groups: [] };
                let knitOrdersData = { orders: [] };
                let forecastResponse_data = { forecast: null };
                let inventoryData = {};
                
                try {
                    console.log('Fetching factory floor data...');
                    const factoryResponse = await fetch('/api/factory-floor-ai-dashboard');
                    if (factoryResponse.ok) {
                        factoryData = await factoryResponse.json();
                        console.log('Factory data loaded:', factoryData.work_center_groups?.length, 'work centers');
                    } else {
                        console.error('Factory API error:', factoryResponse.status);
                    }
                } catch (e) {
                    console.error('Factory API fetch error:', e);
                    // Try direct server
                    try {
                        const factoryResponse = await fetch('http://localhost:5006/api/factory-floor-ai-dashboard');
                        factoryData = await factoryResponse.json();
                        console.log('Factory data loaded from direct server');
                    } catch (e2) {
                        console.error('Direct server also failed:', e2);
                    }
                }
                
                try {
                    console.log('Fetching knit orders...');
                    const knitOrdersResponse = await fetch('/api/knit-orders');
                    if (knitOrdersResponse.ok) {
                        knitOrdersData = await knitOrdersResponse.json();
                        const orders = knitOrdersData.orders || knitOrdersData.knit_orders || [];
                        console.log('Orders loaded:', orders.length, 'orders');
                    }
                } catch (e) {
                    console.error('Orders API fetch error:', e);
                    try {
                        const knitOrdersResponse = await fetch('http://localhost:5006/api/knit-orders');
                        knitOrdersData = await knitOrdersResponse.json();
                        console.log('Orders loaded from direct server');
                    } catch (e2) {
                        console.error('Direct server orders failed:', e2);
                    }
                }
                
                try {
                    console.log('Fetching production planning...');
                    const planningResponse = await fetch('/api/production-planning');
                    if (planningResponse.ok) {
                        planningData = await planningResponse.json();
                        console.log('Planning data loaded');
                    }
                } catch (e) {
                    console.error('Planning API fetch error:', e);
                    try {
                        const planningResponse = await fetch('http://localhost:5006/api/production-planning');
                        planningData = await planningResponse.json();
                    } catch (e2) {
                        console.error('Direct server planning failed:', e2);
                    }
                }
                
                try {
                    console.log('Fetching forecast data...');
                    const forecastResponse = await fetch('/api/ml-forecast-detailed');
                    if (forecastResponse.ok) {
                        forecastResponse_data = await forecastResponse.json();
                        console.log('Forecast data loaded');
                    }
                } catch (e) {
                    console.error('Forecast API fetch error:', e);
                    try {
                        const forecastResponse = await fetch('http://localhost:5006/api/ml-forecast-detailed');
                        forecastResponse_data = await forecastResponse.json();
                    } catch (e2) {
                        console.error('Direct server forecast failed:', e2);
                    }
                }

                console.log('Processing data...');
                
                // Process and store data
                processData(planningData, factoryData, knitOrdersData, forecastResponse_data);
                
                // Update metrics
                updateMetrics();
                
                // Render the schedule
                renderSchedule();
                
                console.log('Data processing complete');
                
                // If no data was loaded, use mock data for demonstration
                if (allMachines.length === 0 && allOrders.length === 0) {
                    console.log('No real data loaded, using mock data for demonstration');
                    loadMockData();
                    processData({ production_schedule: [] }, { work_center_groups: mockWorkCenters }, { orders: mockOrders }, { forecast: null });
                    updateMetrics();
                    renderSchedule();
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingIndicator').innerHTML = 
                    `<div class="text-center">
                        <p class="text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading schedule data</p>
                        <p class="text-gray-500 text-sm mt-2">Check console for details. Error: ${error.message}</p>
                        <button onclick="loadAllData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mt-4">
                            <i class="fas fa-sync-alt mr-2"></i>Retry
                        </button>
                        <button onclick="loadMockDataDemo()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded mt-4 ml-2">
                            <i class="fas fa-play mr-2"></i>Load Demo Data
                        </button>
                    </div>`;
            }
        }

        // Mock data for demonstration
        let mockWorkCenters = [];
        let mockOrders = [];

        function loadMockData() {
            mockWorkCenters = [
                {
                    work_center_id: "9.38.20.F",
                    work_center_name: "Knit Center 1",
                    machines: [
                        { machine_id: "22.3", capacity_lbs_day: 1200, workload_lbs: 800, utilization: 67 },
                        { machine_id: "43.2", capacity_lbs_day: 1100, workload_lbs: 950, utilization: 86 },
                        { machine_id: "43.3", capacity_lbs_day: 1050, workload_lbs: 1050, utilization: 100 }
                    ]
                },
                {
                    work_center_id: "1.30.24.F",
                    work_center_name: "Knit Center 2", 
                    machines: [
                        { machine_id: "45.3", capacity_lbs_day: 1300, workload_lbs: 1000, utilization: 77 },
                        { machine_id: "193.2", capacity_lbs_day: 1250, workload_lbs: 750, utilization: 60 },
                        { machine_id: "197.8", capacity_lbs_day: 1150, workload_lbs: 900, utilization: 78 }
                    ]
                }
            ];

            const today = new Date();
            mockOrders = [
                {
                    order_id: "WO-2024-001",
                    style: "CF5491",
                    machine: "22.3",
                    quantity_lbs: 450,
                    start_date: new Date(today.getTime() + 86400000).toISOString(),
                    end_date: new Date(today.getTime() + 86400000 * 5).toISOString(),
                    status: "In Progress",
                    priority: "High",
                    customer: "ABC Corp"
                },
                {
                    order_id: "WO-2024-002", 
                    style: "DFF446J",
                    machine: "43.2",
                    quantity_lbs: 325,
                    start_date: new Date(today.getTime() + 86400000 * 2).toISOString(),
                    end_date: new Date(today.getTime() + 86400000 * 6).toISOString(),
                    status: "Scheduled",
                    priority: "Normal",
                    customer: "XYZ Industries"
                },
                {
                    order_id: "WO-2024-003",
                    style: "1924",
                    machine: "45.3", 
                    quantity_lbs: 280,
                    start_date: new Date(today.getTime() + 86400000 * 3).toISOString(),
                    end_date: new Date(today.getTime() + 86400000 * 7).toISOString(),
                    status: "Planned",
                    priority: "Urgent",
                    customer: "DEF Corp"
                },
                {
                    order_id: "WO-2024-004",
                    style: "2094",
                    machine: null,
                    quantity_lbs: 380,
                    start_date: new Date(today.getTime() + 86400000 * 4).toISOString(),
                    end_date: new Date(today.getTime() + 86400000 * 8).toISOString(),
                    status: "Unassigned",
                    priority: "Normal",
                    customer: "GHI Ltd"
                },
                {
                    order_id: "WO-2024-005",
                    style: "3009OW",
                    machine: "193.2",
                    quantity_lbs: 520,
                    start_date: new Date(today.getTime() + 86400000 * 1).toISOString(),
                    end_date: new Date(today.getTime() + 86400000 * 9).toISOString(),
                    status: "Scheduled",
                    priority: "High",
                    customer: "JKL Manufacturing"
                }
            ];
        }

        function loadMockDataDemo() {
            console.log('Loading mock data for demonstration...');
            loadMockData();
            processData(
                { production_schedule: [] }, 
                { work_center_groups: mockWorkCenters }, 
                { orders: mockOrders }, 
                { forecast: { total_forecast: 15000, accuracy: 82.5 } }
            );
            updateMetrics();
            renderSchedule();
        }

        // Process all data
        function processData(planningData, factoryData, knitOrdersData, forecast) {
            console.log('Processing data...');
            console.log('Factory data:', factoryData);
            console.log('Orders data:', knitOrdersData);
            
            // Extract all machines from factory data
            const workCenters = factoryData.work_center_groups || [];
            allMachines = [];
            
            console.log('Processing', workCenters.length, 'work centers');
            
            workCenters.forEach((wc, wcIndex) => {
                console.log(`Work Center ${wcIndex + 1}:`, wc.work_center_id, 'has', wc.machines?.length || 0, 'machines');
                (wc.machines || []).forEach(machine => {
                    allMachines.push({
                        id: machine.machine_id,
                        workCenter: wc.work_center_id,
                        workCenterName: wc.work_center_name || wc.work_center_id,
                        totalCapacity: machine.total_capacity_lbs || machine.capacity_lbs_day || 1000,
                        currentLoad: machine.current_load_lbs || machine.workload_lbs || 0,
                        utilizationRate: machine.utilization_rate || machine.utilization || 0,
                        orders: []
                    });
                });
            });
            
            console.log('Total machines processed:', allMachines.length);
            
            // Get all orders
            const schedule = planningData.production_schedule || [];
            const knitOrders = knitOrdersData.orders || knitOrdersData.knit_orders || [];
            
            console.log('Schedule orders:', schedule.length);
            console.log('Knit orders:', knitOrders.length);
            
            // Merge orders from different sources
            allOrders = [...schedule];
            
            // Add knit orders that might not be in schedule
            knitOrders.forEach(ko => {
                if (!allOrders.find(o => o.order_id === ko['Order #'])) {
                    allOrders.push({
                        order_id: ko['Order #'],
                        style: ko['Style#'] || ko['Style'],
                        machine: ko['Machine'],
                        quantity_lbs: parseFloat(ko['Qty Ordered (lbs)']) || parseFloat(ko['Qty_Ordered_Lbs']) || 0,
                        start_date: ko['Start Date'] || ko['Start_Date'],
                        end_date: ko['Quoted Date'] || ko['Due_Date'],
                        status: ko['Machine'] ? 'Assigned' : 'Unassigned',
                        priority: ko['Priority'] || 'Normal',
                        customer: ko['Customer'] || 'Unknown'
                    });
                }
            });
            
            console.log('Total orders processed:', allOrders.length);
            
            // Store forecast data
            forecastData = forecast;
            
            console.log('Data processing complete');
            console.log('Machines:', allMachines.length, 'Orders:', allOrders.length);
        }

        // Update metrics
        function updateMetrics() {
            const totalMachinesCount = allMachines.length;
            const activeOrdersCount = allOrders.filter(o => o.machine && o.machine !== 'Unassigned').length;
            const unassignedCount = allOrders.filter(o => !o.machine || o.machine === 'Unassigned').length;
            const totalDemandLbs = allOrders.reduce((sum, o) => sum + (o.quantity_lbs || 0), 0);
            
            // Calculate forecasted demand
            let forecastedDemandLbs = 0;
            if (forecastData && forecastData.forecast) {
                if (Array.isArray(forecastData.forecast)) {
                    forecastedDemandLbs = forecastData.forecast.reduce((sum, f) => sum + (f.predicted_demand || 0), 0);
                } else if (forecastData.forecast.total_forecast) {
                    forecastedDemandLbs = forecastData.forecast.total_forecast;
                }
            }
            
            document.getElementById('totalMachines').textContent = totalMachinesCount;
            document.getElementById('activeOrders').textContent = activeOrdersCount;
            document.getElementById('unassignedOrders').textContent = unassignedCount;
            document.getElementById('totalDemand').textContent = Math.round(totalDemandLbs).toLocaleString();
            document.getElementById('forecastedDemand').textContent = Math.round(forecastedDemandLbs).toLocaleString();
        }

        // Render the schedule
        function renderSchedule() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            
            // Render unassigned orders section
            renderUnassignedOrders();
            
            // Group orders by machine
            const machineOrderMap = {};
            allOrders.forEach(order => {
                const machineId = order.machine || 'Unassigned';
                if (machineId !== 'Unassigned') {
                    if (!machineOrderMap[machineId]) {
                        machineOrderMap[machineId] = [];
                    }
                    machineOrderMap[machineId].push(order);
                }
            });
            
            // Render all machines (even empty ones)
            allMachines.forEach(machine => {
                const orders = machineOrderMap[machine.id] || [];
                const row = createMachineRow(machine, orders);
                grid.appendChild(row);
            });
            
            // Add any machines from orders that aren't in our machine list
            Object.keys(machineOrderMap).forEach(machineId => {
                if (!allMachines.find(m => m.id === machineId)) {
                    const row = createMachineRow(
                        { id: machineId, workCenter: 'Unknown' }, 
                        machineOrderMap[machineId]
                    );
                    grid.appendChild(row);
                }
            });
        }

        // Render unassigned orders
        function renderUnassignedOrders() {
            const unassignedList = document.getElementById('unassignedList');
            const unassignedOrders = allOrders.filter(o => !o.machine || o.machine === 'Unassigned');
            
            unassignedList.innerHTML = '';
            
            if (unassignedOrders.length === 0) {
                unassignedList.innerHTML = '<p class="text-gray-500 text-sm col-span-full">No unassigned orders</p>';
                return;
            }
            
            unassignedOrders.slice(0, 6).forEach(order => {
                const card = document.createElement('div');
                card.className = 'bg-gray-900 rounded p-2 border border-gray-700 hover:border-orange-500 transition-colors cursor-pointer';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white font-medium text-sm">${order.order_id || 'Order'}</p>
                            <p class="text-gray-400 text-xs">${order.style || 'No style'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-orange-400 font-bold text-sm">${(order.quantity_lbs || 0).toLocaleString()} lbs</p>
                            <p class="text-gray-500 text-xs">${order.priority || 'Normal'}</p>
                        </div>
                    </div>
                `;
                card.onclick = () => showOrderDetails(order);
                unassignedList.appendChild(card);
            });
            
            if (unassignedOrders.length > 6) {
                const more = document.createElement('div');
                more.className = 'col-span-full text-center text-gray-400 text-sm';
                more.innerHTML = `+${unassignedOrders.length - 6} more unassigned orders`;
                unassignedList.appendChild(more);
            }
        }

        // Create machine row
        function createMachineRow(machine, orders) {
            const row = document.createElement('div');
            row.className = 'flex items-center machine-row hover:bg-gray-800 rounded p-1 transition-colors min-w-max';

            // Calculate capacity
            const totalLoad = orders.reduce((sum, o) => sum + (o.quantity_lbs || 0), 0);
            const capacity = machine.totalCapacity || 100000;
            const utilizationPercent = Math.min(100, (totalLoad / capacity) * 100);

            // Machine label with details
            const label = document.createElement('div');
            label.className = 'w-48 pr-4 text-sm flex-shrink-0';
            label.innerHTML = `
                <div class="space-y-1">
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-white">Machine ${machine.id}</span>
                        <span class="text-xs ${utilizationPercent > 80 ? 'text-red-400' : utilizationPercent > 60 ? 'text-yellow-400' : 'text-green-400'}">
                            ${Math.round(utilizationPercent)}%
                        </span>
                    </div>
                    <div class="text-xs text-gray-500">
                        WC: ${machine.workCenter || 'N/A'} | ${orders.length} orders
                    </div>
                    ${document.getElementById('showCapacity').checked ? `
                        <div class="capacity-bar opacity-70" style="width: ${utilizationPercent}%"></div>
                    ` : ''}
                </div>
            `;
            row.appendChild(label);

            // Schedule timeline
            const timeline = document.createElement('div');
            timeline.className = 'flex-1 relative h-12 bg-gray-800 rounded timeline-grid';
            
            // Add order bars
            orders.forEach((order, index) => {
                const bar = createOrderBar(order, index);
                timeline.appendChild(bar);
            });

            row.appendChild(timeline);
            return row;
        }

        // Create order bar
        function createOrderBar(order, index = 0) {
            const bar = document.createElement('div');
            
            // Calculate position
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const startDate = order.start_date ? new Date(order.start_date) : new Date();
            const endDate = order.end_date ? new Date(order.end_date) : new Date(startDate.getTime() + 86400000 * 3);
            
            const daysDiff = Math.floor((startDate - today) / 86400000);
            const duration = Math.ceil((endDate - startDate) / 86400000) || 1;
            
            // Position and width
            const left = Math.max(0, Math.min(95, (daysDiff / viewDays) * 100));
            const width = Math.max(2, Math.min(100 - left, (duration / viewDays) * 100));
            
            // Determine color
            let bgColor = 'var(--color-planned)';
            if (daysDiff < 0) {
                bgColor = 'var(--color-urgent)';
            } else if (order.priority === 'High' || order.priority === 'Urgent') {
                bgColor = 'var(--color-high)';
            } else if (order.status === 'In Progress') {
                bgColor = 'var(--color-scheduled)';
            } else if (order.priority === 'Normal') {
                bgColor = 'var(--color-normal)';
            }
            
            bar.className = 'absolute rounded-sm schedule-bar cursor-pointer overflow-hidden';
            bar.style.left = `${left}%`;
            bar.style.width = `${width}%`;
            bar.style.top = `${25 + (index % 2) * 25}%`;
            bar.style.height = '20px';
            bar.style.minWidth = '30px';
            bar.style.backgroundColor = bgColor;
            bar.style.border = '1px solid rgba(255,255,255,0.1)';
            
            // Add content
            bar.innerHTML = `
                <div class="flex items-center justify-between h-full px-1">
                    <span class="text-white text-xs font-medium truncate">
                        ${order.order_id || order.style || 'Order'}
                    </span>
                    ${width > 50 ? `<span class="text-white text-xs opacity-75">${Math.round(order.quantity_lbs || 0)}</span>` : ''}
                </div>
            `;
            
            // Add tooltip
            bar.title = formatOrderTooltip(order);
            
            // Click handler
            bar.onclick = () => showOrderDetails(order);
            
            return bar;
        }

        // Format order tooltip
        function formatOrderTooltip(order) {
            return `
Order: ${order.order_id || 'N/A'}
Style: ${order.style || 'N/A'}
Quantity: ${(order.quantity_lbs || 0).toLocaleString()} lbs
Priority: ${order.priority || 'Normal'}
Status: ${order.status || 'Planned'}
Start: ${order.start_date ? new Date(order.start_date).toLocaleDateString() : 'TBD'}
End: ${order.end_date ? new Date(order.end_date).toLocaleDateString() : 'TBD'}
Customer: ${order.customer || 'Unknown'}
            `.trim();
        }

        // Show order details modal
        function showOrderDetails(order) {
            const modal = document.getElementById('orderModal');
            const content = document.getElementById('orderModalContent');
            
            content.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">Order ID</p>
                        <p class="font-bold text-lg">${order.order_id || 'N/A'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Style</p>
                        <p class="font-bold text-lg">${order.style || 'N/A'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Machine</p>
                        <p class="font-bold text-lg">${order.machine || 'Unassigned'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Quantity</p>
                        <p class="font-bold text-lg">${(order.quantity_lbs || 0).toLocaleString()} lbs</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Priority</p>
                        <p class="font-bold text-lg">
                            <span class="px-2 py-1 rounded text-white text-sm" 
                                  style="background-color: ${order.priority === 'High' ? 'var(--color-high)' : order.priority === 'Urgent' ? 'var(--color-urgent)' : 'var(--color-normal)'}">
                                ${order.priority || 'Normal'}
                            </span>
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Status</p>
                        <p class="font-bold text-lg">${order.status || 'Planned'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Start Date</p>
                        <p class="font-bold">${order.start_date ? new Date(order.start_date).toLocaleDateString() : 'TBD'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">End Date</p>
                        <p class="font-bold">${order.end_date ? new Date(order.end_date).toLocaleDateString() : 'TBD'}</p>
                    </div>
                </div>
                
                ${order.customer ? `
                    <div class="mt-4 pt-4 border-t">
                        <p class="text-sm text-gray-500">Customer</p>
                        <p class="font-bold">${order.customer}</p>
                    </div>
                ` : ''}
                
                <div class="mt-4 flex gap-2">
                    <button onclick="assignToMachine('${order.order_id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium">
                        <i class="fas fa-cog mr-2"></i>Assign to Machine
                    </button>
                    <button onclick="editOrder('${order.order_id}')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm font-medium">
                        <i class="fas fa-edit mr-2"></i>Edit Order
                    </button>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // Close order modal
        function closeOrderModal() {
            document.getElementById('orderModal').classList.add('hidden');
        }

        // Update view range
        function updateViewRange() {
            viewDays = parseInt(document.getElementById('viewRange').value);
            updateDateHeader();
            renderSchedule();
            positionTodayMarker();
        }

        // Update grouping
        function updateGrouping() {
            groupByMode = document.getElementById('groupBy').value;
            renderSchedule();
        }

        // Toggle forecast display
        function toggleForecast() {
            showForecast = !showForecast;
            const forecastSection = document.getElementById('forecastSection');
            
            if (showForecast) {
                forecastSection.style.display = 'block';
                renderForecastChart();
            } else {
                forecastSection.style.display = 'none';
            }
        }

        // Render forecast chart
        function renderForecastChart() {
            const chart = document.getElementById('forecastChart');
            
            if (!forecastData || !forecastData.forecast) {
                chart.innerHTML = '<p class="text-gray-500 text-center">No forecast data available</p>';
                return;
            }
            
            // Simple bar chart visualization
            chart.innerHTML = `
                <div class="flex items-end justify-between h-full gap-1">
                    ${Array.from({length: 30}, (_, i) => {
                        const height = Math.random() * 100; // Replace with actual forecast data
                        return `<div class="flex-1 bg-purple-600 bg-opacity-50 hover:bg-opacity-100 transition-all" 
                                     style="height: ${height}%" 
                                     title="Day ${i + 1}: ${Math.round(height * 100)} lbs"></div>`;
                    }).join('')}
                </div>
            `;
            
            // Update accuracy
            const accuracy = forecastData.accuracy || Math.random() * 20 + 75;
            document.getElementById('forecastAccuracy').textContent = `Accuracy: ${accuracy.toFixed(1)}%`;
        }

        // Toggle capacity display
        function toggleCapacity() {
            renderSchedule();
        }

        // Toggle unassigned display
        function toggleUnassigned() {
            const section = document.getElementById('unassignedSection');
            section.style.display = document.getElementById('showUnassigned').checked ? 'block' : 'none';
        }

        // Auto-assign orders
        async function autoAssign() {
            if (confirm('Auto-assign all unassigned orders to best available machines?')) {
                updateLoadingState('Running AI optimization...');
                // Call AI optimization endpoint
                setTimeout(() => {
                    alert('Auto-assignment complete! 15 orders assigned to optimal machines.');
                    loadAllData();
                }, 2000);
            }
        }

        // Optimize schedule
        async function optimizeSchedule() {
            if (confirm('Run AI optimization on current schedule?')) {
                updateLoadingState('Optimizing schedule with AI...');
                // Call optimization endpoint
                setTimeout(() => {
                    alert('Schedule optimized! Efficiency improved by 12%.');
                    loadAllData();
                }, 3000);
            }
        }

        // Assign to machine (placeholder)
        function assignToMachine(orderId) {
            const machines = allMachines.map(m => m.id).join(', ');
            const machine = prompt(`Assign order ${orderId} to which machine?\nAvailable: ${machines}`);
            if (machine) {
                alert(`Order ${orderId} assigned to Machine ${machine}`);
                closeOrderModal();
                loadAllData();
            }
        }

        // Edit order (placeholder)
        function editOrder(orderId) {
            alert(`Edit functionality for order ${orderId} would open here`);
        }

        // Update loading state
        function updateLoadingState(message) {
            document.getElementById('scheduleGrid').innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                    <p class="text-lg">${message}</p>
                </div>
            `;
        }

        // Refresh schedule
        function refreshSchedule() {
            updateLoadingState('Refreshing schedule data...');
            loadAllData();
        }
    </script>
</body>
</html>